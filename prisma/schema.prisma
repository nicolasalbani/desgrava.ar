generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  
}

// ─── NextAuth Models ───────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]
  arcaCredential ArcaCredential?
  invoices       Invoice[]
  automationJobs AutomationJob[]
  preference     UserPreference?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── ARCA Credentials ──────────────────────────────────────────

model ArcaCredential {
  id             String   @id @default(cuid())
  userId         String   @unique
  cuit           String // XX-XXXXXXXX-X
  encryptedClave String
  iv             String
  authTag        String
  isValidated    Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Invoices ──────────────────────────────────────────────────

model Invoice {
  id                String            @id @default(cuid())
  userId            String
  deductionCategory DeductionCategory
  providerCuit      String
  providerName      String?
  invoiceType       InvoiceType
  invoiceNumber     String? // "XXXXX-YYYYYYYY" (punto de venta + comp. nro)
  invoiceDate       DateTime? // Date printed on the invoice
  amount            Decimal           @db.Decimal(12, 2)
  fiscalYear        Int
  fiscalMonth       Int // 1-12
  description       String?
  source            InvoiceSource     @default(MANUAL)
  ocrConfidence     Float? // 0-1 for OCR-sourced
  siradiqStatus     SiradiqStatus     @default(PENDING)
  originalFilename  String?
  fileData          Bytes?
  fileMimeType      String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  automationJobs AutomationJob[]

  @@index([userId, fiscalYear])
  @@index([userId, siradiqStatus])
}

// ─── Automation Jobs ───────────────────────────────────────────

model AutomationJob {
  id            String        @id @default(cuid())
  userId        String
  invoiceId     String?
  jobType       JobType
  status        JobStatus     @default(PENDING)
  attempts      Int           @default(0)
  maxAttempts   Int           @default(3)
  logs          Json          @default("[]")
  screenshotUrl String?
  errorMessage  String?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([userId, status])
}

// ─── User Preferences ──────────────────────────────────────────

model UserPreference {
  id             String  @id @default(cuid())
  userId         String  @unique
  defaultFiscalYear Int?
  notifications  Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Enums ─────────────────────────────────────────────────────

enum DeductionCategory {
  CUOTAS_MEDICO_ASISTENCIALES
  PRIMAS_SEGURO_MUERTE
  PRIMAS_AHORRO_SEGUROS_MIXTOS
  APORTES_RETIRO_PRIVADO
  DONACIONES
  INTERESES_HIPOTECARIOS
  GASTOS_SEPELIO
  GASTOS_MEDICOS
  GASTOS_INDUMENTARIA_TRABAJO
  ALQUILER_VIVIENDA
  SERVICIO_DOMESTICO
  APORTE_SGR
  VEHICULOS_CORREDORES
  INTERESES_CORREDORES
  GASTOS_EDUCATIVOS
  OTRAS_DEDUCCIONES
}

enum InvoiceType {
  FACTURA_A
  FACTURA_B
  FACTURA_C
  NOTA_DEBITO_A
  NOTA_DEBITO_B
  NOTA_DEBITO_C
  NOTA_CREDITO_A
  NOTA_CREDITO_B
  NOTA_CREDITO_C
  RECIBO
  TICKET
}

enum InvoiceSource {
  MANUAL
  PDF
  OCR
}

enum SiradiqStatus {
  PENDING
  QUEUED
  PROCESSING
  PREVIEW_READY
  CONFIRMED
  SUBMITTED
  FAILED
}

enum JobType {
  VALIDATE_CREDENTIALS
  SUBMIT_INVOICE
  BULK_SUBMIT
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}
